# Elasticserchの深淵、Codecについて調べた

Luceneがインデックスにアクセスする際に、低レベルでは Codec API を介して行われます。これはインデックスへの低レベルな具体的な操作を抽象化するのに役立ちます。

セグメント毎にCodecを自由に設定できます。
Codecは次の9つのformatを定義しています。

1. StoredFieldsFormat：各ドキュメントの保存されたフィールドをエンコードおよびデコードする。

2. TermVectorsFormat：単一のドキュメントの用語ベクトルをエンコードおよびデコードする。

3. LiveDocsFormat：オプションのビットセットを処理して、削除されていないドキュメントをマークする。

4. NormsFormat：インデックスをエンコードおよびデコードするときのスコアリングの正規化係数。

5. SegmentInfoFormat：セグメント名、含まれているドキュメントの数、一意のIDなどのストレージセグメントのメタデータ情報。

6. FieldInfosFormat：フィールドの名前、フィールドにインデックスが付けられているかどうか、保存されているかどうかなど、単一のフィールドのメタデータ情報を記録する。

7. PostingsFormat：すべてのフィールド、用語、ドキュメント、位置、ペイロード、オフセットなど、反転インデックスの関連するすべてのコンテンツをカバーする。クエリはこのAPIを使用して、一致するドキュメントを検索する。

8. DocValuesFormat：各ドキュメントの列ストレージデータを処理する。デフォルトの形式は、データをディスクに保存し、そのインデックスをメモリにロードして、すばやくランダムにアクセスできるようにする。

9. CompoundFormat：複合ファイル形式がオンになっている場合に使用される（デフォルトで有効になっています）。上記のすべての形式で書き込まれた複数の個別のファイルをセグメントごとに2つのファイルにマージして、検索プロセスで必要なファイルハンドルの数を減らす。


Cordec を作成するときに、これらの9つの形式すべてを実装する必要はなく、変更しないFormatはそのままに、カスタマイズ実装だけを差し替えれるようになっています。

まずは最も簡単なCodecの実装として提供されている、SimpleText Codec をみていきます。当然これは学習用の Codecなので本番では使えませんが、Codecの入門には良さそうです。

Codecの重要な特性の1つは、読み取り時に自身をインスタンス化するために必要なすべてのものをインデックスにエンコードする必要があることです。LuceneはセグメントファイルからCodecの名前を読み取り、JavaのSPIを使用してCodecインスタンスを取得し、そのCodecインスタンスを使用してすべてにアクセスします。

https://opensourceconnections.com/blog/2013/06/05/build-your-own-lucene-codec/
